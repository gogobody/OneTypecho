var Remarkable=require("./remarkable.js"),parser=new Remarkable({html:!0}),prism=require("./prism.js");
function parse(w,q){q||(q={});var l=parser.parse(w,{}),v=[],f=[],m=0,r=[0,0],t,p=function(a){var d=[],e,b={};if("htmlblock"===a.type)for(var n=/<video.*?src\s*=\s*['"]*([^\s^'^"]+).*?(poster\s*=\s*['"]*([^\s^'^"]+).*?)?(?:\/\s*>|<\/video>)/g,g=a.content.replace(/\n/g,"");a=n.exec(g);){if(a[1]){var h={type:"video",src:a[1]};a[3]&&(h.poster=a[3]);d.push(h)}}else a.children&&a.children.forEach(function(c,k){-1<["text","code"].indexOf(c.type)?(d.push({type:e||c.type,content:c.content,data:b}),e="",b=
{}):"del_open"===c.type?e="deleted":"softbreak"!==c.type&&("hardbreak"===c.type?d.push({type:"text",content:"\n"}):"strong_open"===c.type?e="em"===e?"strong_em":"strong":"em_open"===c.type?e="strong"===e?"strong_em":"em":"link_open"===c.type?q.link&&(e="link",b={href:c.href}):"image"===c.type&&d.push({type:c.type,src:c.src}))});return d},x=function(a,d,e){if("htmlblock"===a.type)return p(a);if("heading_open"===a.type)return{type:"h"+a.hLevel,content:p(l[d+1])};if("paragraph_open"===a.type){a="";f.length&&
(a=f.join("_")+"_");var b=p(l[d+1]);"li"===f[f.length-1]&&"ol"===f[f.length-2]&&(d="\u3000",e&&(d=r[m-1]+". "),b.unshift({type:"text",content:d}));return{type:a+"p",content:b}}if("fence"===a.type||"code"===a.type){b=a.content;e=!1;q.highlight&&a.params&&prism.languages[a.params]&&(b=prism.tokenize(b,prism.languages[a.params]),e=!0);var n=function(g,h,c){h=void 0===h?[]:h;c=void 0===c?"":c;Array.isArray(g)?g.forEach(function(k){if("object"===typeof k)Array.isArray(k.content)?n(k.content,h,k.type):
n(k,h,k.type);else{var u={};u.type=c||"text";u.content=k;h.push(u)}}):h.push(g);return h};e&&(a=b,b=[],a.forEach(function(g){Array.isArray(g.content)?b=b.concat(n(g.content,[],"")):b.push(g)}));return{type:"code",highlight:e,content:b}}if("bullet_list_open"===a.type)f.push("ul"),m++;else if("ordered_list_open"===a.type)f.push("ol"),m++;else if("list_item_open"===a.type)f.push("li"),"ol"===f[f.length-2]&&r[m-1]++;else if("list_item_close"===a.type)f.pop();else if("bullet_list_close"===a.type)f.pop(),
m--;else if("ordered_list_close"===a.type)f.pop(),m--,r[m]=0;else if("blockquote_open"===a.type)f.push("blockquote");else if("blockquote_close"===a.type)f.pop();else{if("tr_open"===a.type)return t={type:"table_tr",content:[]};"th_open"===a.type?t.content.push({type:"table_th",content:p(l[d+1]).map(function(g){return g.content}).join("")}):"td_open"===a.type&&t.content.push({type:"table_td",content:p(l[d+1]).map(function(g){return g.content}).join("")})}};l.forEach(function(a,d){var e=!1;"paragraph_open"===
a.type&&l[d-1]&&"list_item_open"===l[d-1].type&&(e=!0);if(a=x(a,d,e))Array.isArray(a)||(a=[a]),a.forEach(function(b){Array.isArray(b.content)?b.isArray=!0:b.isArray=!1;v.push(b)})});return v}module.exports={parse:parse};
